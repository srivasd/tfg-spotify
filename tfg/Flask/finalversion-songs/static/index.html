<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="http://neo4j-contrib.github.io/developer-resources/language-guides/assets/css/main.css">
    <title>Spotify Recommendation System</title>
</head>

<body>
<div id="graph">
</div>
<div role="navigation" class="navbar navbar-default navbar-static-top">
    <div class="container">
        <div class="row">
            <div class="col-sm-6 col-md-6">
                <ul class="nav navbar-nav">
                    <li>
                        <form role="song" class="navbar-form" id="song">
                            <div class="form-group">
                                <input type="text" style="width: 49%;" placeholder="Search for Song Title" class="form-control" name="song">
                                <input type="text" style="width: 49%;" placeholder="Search for Artist Name" class="form-control" name="artist">
                            </div>
                            <button class="btn btn-default">Search</button>
                        </form>
                    </li>
                </ul>
            </div>
            <div class="navbar-header col-sm-6 col-md-6">
                <div class="logo-well">
                    <a href="http://neo4j.com">
                    <img src="http://neo4j-contrib.github.io/developer-resources/language-guides/assets/img/logo-white.svg" alt="Neo4j World's Leading Graph Database" id="logo">
                    </a>
                </div>
                <div class="navbar-brand">
                    <div class="brand">Spotify Recommendation System</div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-6">
    </div>
    <div class="col-md-6">
        <div class="panel panel-default">
            <div class="panel-heading" id="title"></div>
            <div class="row">
                <div class="col-sm-6 col-md-6">
                    <img src="" class="well" id="poster"/>
                </div>
                <div class="col-md-6 col-sm-6">
                    <h3 id="title2"></h3>
                    <ul id="songdetails">
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
<style type="text/css">
    .node.song1 { stroke: #1dff2b; fill: #1dff2b; }
    .node.artist1 { stroke: #606060; fill: #606060; }
    .node.song2 { stroke: #1dff2b; fill: #1dff2b; }
    .node.artist2 { stroke: #606060; fill: #606060; }
    .node.song3 { stroke: #1dff2b; fill: #1dff2b; }
    .node.artist3 { stroke: #606060; fill: #606060; }
    .node.song4 { stroke: #1dff2b; fill: #1dff2b; }
    .node.artist4 { stroke: #606060; fill: #606060; }
    .node.song5 { stroke: #1dff2b; fill: #1dff2b; }
    .node.artist5 { stroke: #606060; fill: #606060; }
    .link { stroke: #999; stroke-opacity: .6; stroke-width: 2px; }

</style>

<script type="text/javascript" src="//code.jquery.com/jquery-1.11.0.min.js"></script>
<script src="http://d3js.org/d3.v3.min.js" type="text/javascript"></script>
<script type="text/javascript">

    $(function () {
        function showDetails() {
            $.get("/details",
                function (data) {
                    console.log(data);
                    var $list = $("#songdetails").empty();
                    if (data.song_clicked.albumname !== "") {
                        $("#title2").text("Song Details");
                        $("#title").text(data.song_clicked.name);
                        $("#poster").attr("src", data.song_clicked.image);

                        $list.append($("<li>" + "Album name: " + data.song_clicked.albumname + "</li>"));
                        $list.append($("<li>" + "Artist: " + data.song_clicked.artist + "</li>"));
                        $list.append($("<li>" + "Duration: " + data.song_clicked.duration + "</li>"));
                        $list.append($("<li>" + "Popularity: " + data.song_clicked.popularity + "/100 </li>"));
                        $list.append($("<li>" + "Release date: " + data.song_clicked.releasedate + "</li>"));
                    }
                }, "json");
        }
        showDetails()
    })

</script>

<script type="text/javascript">

    var width = 1024, height = 768;

    var force = d3.layout.force()
                .gravity(0.05)
                .distance(100)
                .charge(-100)
                .size([width, height]);

    var svg = d3.select("#graph").append("svg")
            .attr("width", "100%").attr("height", "100%")
            .attr("pointer-events", "all");

    function songclicked() {
        console.log(d3.select(this)[0][0].__data__.title);
            d3.select(this).transition()
                    .style("fill", "red")
        window.open("https://open.spotify.com/search/songs/" + d3.select(this)[0][0].__data__.title, '_blank');
        window.location.href = "/?song=" + d3.select(this)[0][0].__data__.title;
    }

    function artistclicked() {
        console.log(d3.select(this)[0][0].__data__.title);
            d3.select(this).transition()
                    .style("fill", "red")
        window.open("https://open.spotify.com/search/artists/" + d3.select(this)[0][0].__data__.title, '_blank');
    }

    d3.json("/graph", function(error, graph) {
		if (error) return;

		// Find blank links, which give the error
        // "Uncaught TypeError: Cannot read property 'weight' of undefined"
        graph.links.forEach(function(link, index, list) {
            if (typeof graph.nodes[link.source] === 'undefined') {
                console.log('undefined source', link);
                graph.nodes[link.source] = graph.nodes[link.target];
            }
            if (typeof graph.nodes[link.target] === 'undefined') {
                console.log('undefined target', link);
                graph.nodes[link.target] = graph.nodes[link.source];
            }
        });

        force.nodes(graph.nodes).links(graph.links).start();

        var link = svg.selectAll(".link")
                .data(graph.links).enter()
                .append("line").attr("class", "link");

        var node = svg.selectAll(".node")
                .data(graph.nodes).enter()
                .append("circle")
                .attr("class", function (d) {
                    return "node "+d.label })
                .attr("r", function (d) {
                    if(d.label == 'song1' || d.label == "artist1"){
                        return 5;
                    } else if (d.label == 'song2' || d.label == "artist2") {
                        return 8;
                    } else if (d.label == 'song3' || d.label == "artist3") {
                        return 11;
                    } else if (d.label == 'song4' || d.label == "artist4") {
                        return 14;
                    } else {
                        return 17;
                    }
                })
                .call(force.drag);

        var songNode1 = svg.selectAll(".node.song1")
            .on("click", songclicked);

        var songNode2 = svg.selectAll(".node.song2")
            .on("click", songclicked);

        var songNode3 = svg.selectAll(".node.song3")
            .on("click", songclicked);

        var songNode4 = svg.selectAll(".node.song4")
            .on("click", songclicked);

        var songNode5 = svg.selectAll(".node.song5")
            .on("click", songclicked);

        var artistNode1 = svg.selectAll(".node.artist1")
            .on("click", artistclicked);

        var artistNode2 = svg.selectAll(".node.artist2")
            .on("click", artistclicked);

        var artistNode3 = svg.selectAll(".node.artist3")
            .on("click", artistclicked);

        var artistNode4 = svg.selectAll(".node.artist4")
            .on("click", artistclicked);

        var artistNode5 = svg.selectAll(".node.artist5")
            .on("click", artistclicked);

        // html title attribute
        node.append("title")
                .text(function (d) { return d.title; })

        // force feed algo ticks
        force.on("tick", function() {
            link.attr("x1", function(d) { return d.source.x; })
                    .attr("y1", function(d) { return d.source.y; })
                    .attr("x2", function(d) { return d.target.x; })
                    .attr("y2", function(d) { return d.target.y; });

            node.attr("cx", function(d) { return d.x; })
                    .attr("cy", function(d) { return d.y; });
        });
    });
</script>
</body>
</html>
